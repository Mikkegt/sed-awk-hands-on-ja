# sed & awk ハンズオン

## 全体の流れ

* 1. edハンズオン
* 2. sedハンズオン
* 3. awkハンズオン

## edハンズオン

sed / awkの使い方を説明するにあたって、まず `ed` コマンドについて知っていただく必要があります。

`ed` は著名なラインエディタで、これをベースとしてsedやex & vimなどが開発されました。

### edの基本的な使い方

ファイルを開くと、対話型のエディタが開きます。

```
ed ファイル名
```

試しに、 `ed SONG.md` と入力してみると、まずファイル内の文字数が表示されます。
これだけでは、何が起こっているかわからないので、ファイルの中身を探索してみましょう。

```
1p
```

と入力すると、1行目の内容が表示されます。

```
2p
```

と入力すると、2行目の内容が表示されます。

ここでの `1`, `2` はファイル内の固有の位置を示すアドレスとなっており、その後にコマンド名 `p` が続いています。
`p` は、指定されたアドレスの内容を出力するコマンドなので、上記のような挙動になっていました。

**最初のポイント**

```
edへの命令は、 `アドレス+コマンド` で構成されている
```

また、コマンドを実行すると、処理中の行が移動します。
また、アドレスはOptionalなので、コマンドのみで実行可能です。
`2p` を実行した後に `p` を実行すると、処理中の行が2行目に移っているので、その行が出力されることがわかります。

### アドレスの使い方

アドレスには複数種類があります。よく使いそうなものを挙げておきます。

#### 数値アドレス

* `1`, `2` などの数値で行番号を指定します

#### 正規表現アドレス

* `/Hallelujah/` などの正規表現で行を指定します

#### その他のアドレス

* . => 現在の行
* $ => 最後の行
* - => 直前の行
* -n => n個前の行
* + => 直後の行
* +n => n個後の行

`man ed` にわかりやすく書かれているので、困ったら参照してみてください。

### 正規表現アドレスを使う

`/Hallelujah/p` と入れてみてください。
すると、次にヒットする `Hallelujah` の行が表示されます。何度か試しに実行してみてください。(/Hall/くらいでいけます)

### 範囲アドレス

2つのアドレスを `,` でつなぐことで使えます。

`1,3p` と入れれば 1~3行目がprintされる
`1,$p` と入れれば 1行目から最終行までがprintされる
`2,/Hallelujah/p` と入れれば、1行目から次のHallelujahまでがprintされる

### コマンドを使う

`p` コマンドしか登場しませんでしたが、ここでいくつか追加のコマンドを紹介します。

#### 迷った時に使えるコマンド

* = => 指定した位置のアドレスを表示する。 `.=` と入れると現在位置のアドレスが見られて便利。
* n => 行番号付きでprintする。めちゃめちゃ便利。
* h => 直前のエラー内容を出力する。`?` が出た時に使う。

#### 置換でめちゃめちゃ使うコマンド

* s/re/re/ => 正規表現での置換。アドレスで指定された行内で初めてマッチした正規表現の対象を置き換える。
* s/re/re/g => 正規表現でのグローバルな置換。アドレスで指定された行内でマッチした全ての正規表現の対象を置き換える。

例) /Hallelujah/ を /Hoge/ に置き換えてみる

`1s/Hallelujah/Hoge/` と入力してみましょう。

結果を `p` で確認すると、 `## Hoge—In Praise of Babel` に変更されていることがわかります。

次に、グローバル置換を使ってみましょう。

`/Hall/p` を2回ほど実行すると、 `Hallelujah, Hallelujah` の行が見つかります。
`.=` で現在の行を確認すると、`12` とわかるので、`12s/Hallelujah/Hoge/g` を実行してみましょう。

結果を `p` で確認すると、 `Hoge, Hoge` に変更されていることがわかります。

#### Viを彷彿とさせるコマンド

* i => 挿入。アドレスで指定された行に文字列を挿入する。範囲指定可能。実行するとInsert modeに入る。
* a => 追加。次の行に文字列を追加する。実行するとInsert modeに入る。
* d => 削除。アドレスで指定された行を削除する。範囲指定可能
* c => 変更。アドレスで指定された行を置き換える。範囲指定可能。実行するとInsert modeに入る。
* u => 直前の操作を取り消す。
* w => 保存する
* q => エディタを終了する

Insert modeからは ^C で抜けることが出来ます。
Insert mode中では、複数行のテキストを入力可能で、あくまで行単位での編集となるので、行が挿入、追加、置換(変更)されることになります。

ed にはこれだけのコマンドが揃っているので、一通りのテキスト編集が実施可能です。
それでは、実際にコードを編集してみましょう。

`ed example1.js`

編集した `wq` で保存した結果、 `node example1.js` が通るようになればOKです。

新規でファイルを作成したい場合は、
`ed ファイル名` でファイルを作成し、 `i` で内容を挿入して `wq` で抜ければOKです。

### グローバルコマンドを使う

edの命令は `アドレス+コマンド` で実行できると言う話をしました。
実は、グローバルコマンド `g/re/command-list` を使うと、ファイル全体の行に対してコマンドを実行できるという、コマンドを受け取るコマンドがあります。
これは、特にファイル全体でマッチする正規表現を置き換えたい時に便利です。

次のファイルを編集してみてください。

`ed example2.js`

地獄のような内容になっているかと思います。

これを実行できるようにするには、 `gonsole` を全て `console` に置き換える必要があります。
ここで、 `g/gonsole/s/gonsole/console/g` を実行すると、全ての `gonsole` を `console` に置き換えることが出来ます。
省略記法として、 `g/gonsole/s//console/g` も使うことが出来ます。

ここまで出来たら、 `Hello` を全て `Hoge` に置き換えて、 `node exmaple2.js` が動くことを確認してみてください。


